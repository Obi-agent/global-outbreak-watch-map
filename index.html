<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Global Outbreak Watch Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Load Leaflet's CSS from the official CDN. The integrity and crossorigin
       attributes help ensure the file is delivered securely. -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
  <style>
    /* Make the map fill the entire viewport */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <!-- Load Leaflet's JavaScript from the official CDN. Make sure this comes
       after the CSS link above. -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    // Define base tile layers with English labels and satellite imagery. The
    // standard OpenStreetMap tiles display names in the local language and
    // cannot be switched to English【880829198194580†L194-L206】.  To provide
    // English labels we instead use Esri's World Street Map tiles.  A second
    // layer provides high‑resolution satellite imagery.  Both layers are
    // public and do not require API keys.
    var streetLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '&copy; Esri — Source: Esri, DeLorme, NAVTEQ, etc.'
    });
    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '&copy; Esri — Source: Esri, Earthstar Geographics'
    });

    // Initialize the map with the English‑labelled street layer by default.
    // We pass the default layers via the `layers` option.  Users can switch
    // between the street and satellite views using the layer control below.
    var map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      layers: [streetLayer]
    });

    // Create a layers control so users can toggle between the base layers.  The
    // keys in this object will be the labels displayed in the control.  You
    // can add additional base maps here if needed.
    var baseMaps = {
      'English labels': streetLayer,
      'Satellite view': satelliteLayer
    };
    L.control.layers(baseMaps).addTo(map);

    // Function to assign colours based on the severity property. You can
    // customise these colours or add more levels as your data evolves.
    function getSeverityColour(severity) {
      switch (severity) {
        case 'Low': return 'green';
        case 'Moderate': return 'orange';
        case 'High': return 'red';
        case 'Critical': return 'black';
        default: return 'blue';
      }
    }

    // Fetch the GeoJSON data generated from the outbreak dataset. We store the
    // GeoJSON in the same directory as this HTML page for simplicity.
    fetch('gow_data.geojson')
      .then(function(response) {
        return response.json();
      })
      .then(function(geojson) {
        // Create a GeoJSON layer with customised markers and pop-ups.
        L.geoJSON(geojson, {
          // Convert each Point feature into a circle marker with a colour
          // reflecting its severity. You can switch to custom icons here
          // instead of circle markers if desired.
          pointToLayer: function(feature, latlng) {
            // Support both upper- and lower-case property names for severity.
            var props = feature.properties;
            var severity = props.Severity || props.severity;
            return L.circleMarker(latlng, {
              radius: 8,
              fillColor: getSeverityColour(severity),
              color: '#000',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          },
          // Attach a pop-up to each feature. The pop-up displays relevant
          // information about the outbreak, including a link to the source.
          onEachFeature: function(feature, layer) {
            var p = feature.properties;
            // Support both upper- and lower-case property names.
            var threat = p.Threat || p.threat || 'Unknown threat';
            var country = p.Country || p.country || 'Unknown location';
            var status = p.Status || p.status || 'Unknown status';
            var severity = p.Severity || p.severity || 'Unknown';
            var updated = p.Date_Last_Updated || p.date_last_updated || '';
            var snapshot = p.Situation_Snapshot || p.situation_snapshot || '';
            var recommendations = p.General_Recommendations || p.general_recommendations || '';
            var source = p.Source_URL || p.source_url || '#';

            var popupContent = '';
            popupContent += '<h3>' + threat + ' (' + country + ')</h3>';
            popupContent += '<p><strong>Status:</strong> ' + status + '<br>';
            popupContent += '<strong>Severity:</strong> ' + severity + '<br>';
            popupContent += '<strong>Last updated:</strong> ' + updated + '</p>';
            popupContent += '<p>' + snapshot + '</p>';
            // Only include the general recommendations if present.
            if (recommendations) {
              popupContent += '<p><em>' + recommendations + '</em></p>';
            }
            // Include the source link if available.
            if (source && source !== '#') {
              popupContent += '<p><a href="' + source + '" target="_blank">Source</a></p>';
            }
            layer.bindPopup(popupContent);
          }
        }).addTo(map);
      })
      .catch(function(error) {
        console.error('Error loading GeoJSON data:', error);
      });
  </script>
</body>
</html>